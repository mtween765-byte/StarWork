<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>StarWork Mini App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body { margin:0; font-family: Arial,sans-serif; background:#0f172a; color:white; }
  header { background:#111827; padding:15px; text-align:center; font-size:22px; font-weight:bold; }
  nav { display:flex; justify-content:space-around; background:#1f2937; }
  nav button { flex:1; padding:12px 0; background:#2563eb; color:white; border:none; cursor:pointer; font-size:16px; }
  nav button.active { background:#3b82f6; }
  .tab { display:none; padding:15px; max-width:480px; margin:0 auto; box-sizing:border-box; }
  .task, .history-item { background:#1e293b; padding:12px; border-radius:8px; margin:10px 0; }
  .task button, .modal button { width:100%; padding:10px; border:none; border-radius:6px; background:#22c55e; color:white; font-size:16px; cursor:pointer; margin-top:6px; }
  input, textarea, select { width:100%; padding:8px; margin:6px 0; border-radius:4px; border:none; }
  #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10; }
  #modal-content { background:#1e293b; padding:20px; border-radius:8px; width:90%; max-width:400px; }
  .close { background:#ef4444; margin-top:10px; }
</style>
</head>
<body>

<header>StarWork Mini App üöÄ</header>

<nav>
  <button class="tab-btn active" onclick="showTab('tasks')">–ó–∞–¥–∞–Ω–∏—è</button>
  <button class="tab-btn" onclick="showTab('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
  <button class="tab-btn" onclick="showTab('wallet')">–ö–æ—à–µ–ª–µ–∫</button>
  <button class="tab-btn" onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
</nav>

<div id="tasks" class="tab"></div>
<div id="history" class="tab"></div>
<div id="wallet" class="tab"></div>
<div id="profile" class="tab"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal">
  <div id="modal-content"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const ADMIN_ID = 6320615361;
let user = tg.initDataUnsafe.user || {id:0, first_name:"–ì–æ—Å—Ç—å"};

let balance = { ton: 1.0, stars: 50 };
let tasks = [
  {id:1, title:"–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ", description:"–û–ø–∏—Å–∞–Ω–∏–µ 1", report_req:"–°–∫—Ä–∏–Ω—à–æ—Ç", reward_type:"TON", reward_amount:0.5, type:"ONE", interval_hours:0, active:true},
  {id:2, title:"–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ", description:"–û–ø–∏—Å–∞–Ω–∏–µ 2", report_req:"–°—Å—ã–ª–∫–∞", reward_type:"STARS", reward_amount:20, type:"MULTI", interval_hours:24, active:true}
];
let history = [];

// –≤–∫–ª–∞–¥–∫–∏
function showTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(tab).style.display='block';
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`nav button[onclick="showTab('${tab}')"]`).classList.add('active');
  if(tab==='tasks') renderTasks();
  if(tab==='history') renderHistory();
  if(tab==='wallet') renderWallet();
  if(tab==='profile') renderProfile();
}

// —Ä–µ–Ω–¥–µ—Ä –∑–∞–¥–∞—á
function renderTasks(){
  let container = document.getElementById('tasks');
  container.innerHTML = '';
  
  if(user.id===ADMIN_ID){
    let form = document.createElement('div');
    form.innerHTML=`
      <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ (–ê–¥–º–∏–Ω)</h3>
      <input id="task_title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <textarea id="task_desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"></textarea>
      <input id="task_report" placeholder="–ß—Ç–æ —É–∫–∞–∑–∞—Ç—å –≤ –æ—Ç—á–µ—Ç–µ"/>
      <select id="task_reward_type"><option>TON</option><option>STARS</option></select>
      <input id="task_reward_amount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"/>
      <select id="task_type"><option value="ONE">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ</option><option value="MULTI">–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–µ</option></select>
      <input id="task_interval" placeholder="–ò–Ω—Ç–µ—Ä–≤–∞–ª —á–∞—Å–æ–≤ (–¥–ª—è –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã—Ö)"/>
      <button onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>
    `;
    container.appendChild(form);
  }

  tasks.filter(t=>t.active).forEach(t=>{
    let div = document.createElement('div');
    div.className='task';
    let adminButtons = '';
    if(user.id===ADMIN_ID){
      adminButtons = `
        <button onclick="approveTask(${t.id})">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button onclick="revisionTask(${t.id})">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</button>
        <button onclick="rejectTask(${t.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      `;
    }
    div.innerHTML=`
      <b>${t.title}</b> [${t.type==='ONE'?'–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ':'–ú–Ω–æ–≥–æ—Ä–∞–∑–æ–≤–æ–µ'}]<br>
      ${t.description}<br>
      –ù–∞–≥—Ä–∞–¥–∞: ${t.reward_amount} ${t.reward_type}<br>
      <button onclick="submitTask(${t.id})">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
      ${adminButtons}
    `;
    container.appendChild(div);
  });
}

// —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
function createTask(){
  let title = document.getElementById('task_title').value;
  let desc = document.getElementById('task_desc').value;
  let report = document.getElementById('task_report').value;
  let reward_type = document.getElementById('task_reward_type').value;
  let reward_amount = parseFloat(document.getElementById('task_reward_amount').value);
  let type = document.getElementById('task_type').value;
  let interval = parseInt(document.getElementById('task_interval').value) || 0;
  let id = tasks.length+1;
  tasks.push({id,title,description:desc,report_req:report,reward_type,reward_amount,type,interval_hours:interval,active:true});
  alert('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
  renderTasks();
}

// –º–æ–¥–∞–ª–∫–∞
function showModal(html){ 
  document.getElementById('modal-content').innerHTML = html + '<button class="close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>';
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

// –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
function submitTask(id){
  let t = tasks.find(x=>x.id===id);
  if(!t) return;
  showModal(`
    <h3>${t.title}</h3>
    <p>${t.report_req}</p>
    <textarea id="report_text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç—á–µ—Ç"></textarea>
    <button onclick="confirmTask(${id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
  `);
}
function confirmTask(id){
  let t = tasks.find(x=>x.id===id);
  let report = document.getElementById('report_text').value;
  if(!report) { alert('–í–≤–µ–¥–∏—Ç–µ –æ—Ç—á–µ—Ç'); return; }
  history.push({ task:t.title, status:'–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', reward:t.reward_amount, reward_type:t.reward_type });
  if(t.type==='ONE') t.active=false;
  closeModal();
  renderTasks();
}

// –∞–¥–º–∏–Ω—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
function approveTask(id){ updateHistory(id,'–ü—Ä–∏–Ω—è—Ç–æ'); }
function revisionTask(id){ updateHistory(id,'–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É'); }
function rejectTask(id){ updateHistory(id,'–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'); }

function updateHistory(id,status){
  let h = history.find(x=>x.task===tasks.find(t=>t.id===id).title);
  if(h) h.status=status;
  renderTasks();
  renderHistory();
}

// –∏—Å—Ç–æ—Ä–∏—è
function renderHistory(){
  let container = document.getElementById('history');
  container.innerHTML='';
  history.forEach(h=>{
    let div = document.createElement('div');
    div.className='history-item';
    div.innerHTML=`<b>${h.task}</b> ‚Äî ${h.status} ‚Äî ${h.reward} ${h.reward_type}`;
    container.appendChild(div);
  });
}

// –∫–æ—à–µ–ª–µ–∫
function renderWallet(){
  let container = document.getElementById('wallet');
  container.innerHTML=`
    <h3>–ë–∞–ª–∞–Ω—Å</h3>
    TON: ${balance.ton}<br>
    Stars: ${balance.stars}<br><br>
    <button onclick="withdraw('TON')">–í—ã–≤–µ—Å—Ç–∏ TON</button>
    <button onclick="withdraw('STARS')">–í—ã–≤–µ—Å—Ç–∏ Stars</button>
  `;
}
function withdraw(type){
  let min = type==='TON'?0.25:15;
  showModal(`
    <h3>–í—ã–≤–æ–¥ ${type}</h3>
    <input id="withdraw_amount" placeholder="–°—É–º–º–∞, –º–∏–Ω ${min}"/>
    <input id="withdraw_wallet" placeholder="–ö–æ—à–µ–ª–µ–∫ / –Ω–∏–∫"/>
    <button onclick="confirmWithdraw('${type}', ${min})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
  `);
}
function confirmWithdraw(type,min){
  let amount = parseFloat(document.getElementById('withdraw_amount').value);
  let wallet = document.getElementById('withdraw_wallet').value;
  if(isNaN(amount) || amount<min || !wallet){ alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'); return; }
  alert(`${type} ${amount} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤—ã–≤–æ–¥ –Ω–∞ ${wallet}`);
  closeModal();
}

// –ø—Ä–æ—Ñ–∏–ª—å
function renderProfile(){
  let container = document.getElementById('profile');
  container.innerHTML=`
    Telegram: ${user.first_name} <br>ID: ${user.id} <br><br>
    <h4>–£—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</h4>
    –ê–¥–º–∏–Ω –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏—è, –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª.<br><br>
    ${user.id===ADMIN_ID?'–í—ã –∞–¥–º–∏–Ω':'–í—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
  `;
}

// –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É
showTab('tasks');
</script>

</body>
</html>
